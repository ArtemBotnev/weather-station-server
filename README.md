# Weather station (Server side)
### The project based on ktor server.
#### Designed to collect data transmitted by controllers from climate sensors. <br> It is a bridge between controllers and the client side with a visual data representation.
#### Controller (client) side of this project you can find here: [weather-station-controllers](https://github.com/ArtemBotnev/weather-station-controllers)

Main functions is: Collect current values of temperature, humidity and so on. These values are sent with controllers via the POST REST method
```/send_measurement```. All values are stored (only!) in memory cache, and are overwritten with each new batch of data from a specific controller with a specific set of sensors. Each controller and sensor must have a unique ID. Otherwise, a collision may occur - data from different sensors will overwrite each other.
<br>
Average, maximum and minimum values per day are also calculated for each measurement with filtering out values that are sensor errors. Sensor error data is provided with a controller. When a new day begins at 12:00 am, the data is cleared, data collection and calculations for the new day begin. The data is stored in memory cache and will be lost if the application restarted.
#### Deploying:
Just run ```bash java -jar weather-station.jar```
<br>
It's possible to specify host and port, there -h host, -p port, like that:
<br>
Just run ```bash java -jar weather-station.jar -h 127.0.0.1 -p 9090```
<br>
By default host is 0.0.0.0, port - 8080
#### Main methods of REST API:
POST ```/send_measurement``` receives data generated by the controller.
<br>
```json
{
  "timeZoneHours": 3,
  "device": {
    "id": 0,
    "type": "Controller",
    "name": "Test controller",
    "location": "My sweet home"
  },
  "measures": [
    {
      "sensorId": "Sensor_0",
      "sensorName": "cool sensor",
      "measureName": "temperature",
      "measureValue": 29.23,
      "measureUnit": "C",
      "sensorPlace": "Just place",
      "sensorError": false
    }
  ]
}
```
POST ```/clear_cache``` technical command for clear all data.
<br>
GET ```/devices``` description all controllers which is clients of this server.
```json
[
  {
    "id": 0,
    "type": "ESP-32",
    "name": "ESP-32 id_0",
    "location": "My sweet home"
  }
]
```
GET ```/last_measurement/{device_id}``` current values from all sensors of controller with a particular device_id.
```json
{
  "timestamp": "2024-12-30T20:18:33.583+03:00",
  "timeZoneHours": 3,
  "device": {
    "id": 0,
    "type": "ESP-32",
    "name": "ESP-32 id_0",
    "location": "My sweet home"
  },
  "measures": [
    {
      "sensorId": "sht-45_temp",
      "sensorName": "sht-45",
      "sensorPlace": "outdoor",
      "measureName": "temperature",
      "measureValue": 0.07,
      "measureUnit": "℃"
    },
    {
      "sensorId": "sht-45_hum",
      "sensorName": "sht-45",
      "sensorPlace": "outdoor",
      "measureName": "humidity",
      "measureValue": 88.99,
      "measureUnit": "%"
    },
    {
      "sensorId": "bme_0_temp",
      "sensorName": "bme_0",
      "sensorPlace": "room",
      "measureName": "temperature",
      "measureValue": 26.76,
      "measureUnit": "℃"
    },
    {
      "sensorId": "bme_0_press",
      "sensorName": "bme_0",
      "sensorPlace": "room",
      "measureName": "atm. pressure",
      "measureValue": 739.85,
      "measureUnit": "mmHg"
    }
  ]
}
```
With query parameter ```additional=true``` get an answer with calculated values.
```/last_measurement/0?additional=true```
```json
{
  "timestamp": "2024-12-30T20:18:33.583+03:00",
  "timeZoneHours": 3,
  "device": {
    "id": 0,
    "type": "ESP-32",
    "name": "ESP-32 id_0",
    "location": "My sweet home"
  },
  "measures": [
    {
      "sensorId": "sht-45_temp",
      "sensorName": "sht-45",
      "sensorPlace": "outdoor",
      "measureName": "temperature",
      "measureValue": 0.0,
      "measureUnit": "℃",
      "dailyCalculation": {
        "maxValue": 0.62,
        "minValue": -0.21,
        "averageValue": 0.191,
        "maxValueTime": "2024-12-30T05:36:02.533+03:00",
        "minValueTime": "2024-12-30T16:18:21.149+03:00"
      }
    }
  ]
}
```

GET ```/device_analytics``` returns error statistic for all sensors of all devices.

GET ```/device_analytics/{device_id}``` returns error statistic for the specific device with {device_id}.